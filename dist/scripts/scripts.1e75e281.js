Mahjong=angular.module("mahjong",[]),Mahjong.service("storage",[function(){return{set:function(a,b){localStorage[a]=angular.toJson(b)},get:function(a){return angular.fromJson(localStorage[a])}}}]),Mahjong.service("players",["storage",function(a){var b=a.get("players")||[{wind:"east"},{wind:"south"},{wind:"west"},{wind:"north"}];return{get:function(){return b},newGame:function(){var c=["east","south","west","north"];return $.each(b,function(a,b){b.name=b.name||"player "+(a+1),b.wind=c[a],b.score=0,b.coins=2e3}),a.set("players",b),b},updateScore:function(c,d){var e=_.last(c.rounds),f=e.score;$.each(b,function(a,c){c.score+=f[a],e.mahjong_idx==a?c.coins+=f[a]*("east"==c.wind?6:4):$.each(b,function(b,d){b!=a&&(e.mahjong_idx==b?c.coins-=f[b]*("east"==d.wind||"east"==c.wind?2:1):(f[b]>f[a]&&(c.coins-=(f[b]-f[a])*("east"==c.wind?2:1)),f[b]<f[a]&&(c.coins+=(f[a]-f[b])*("east"==d.wind?2:1))))})});var g=b[e.mahjong_idx].wind;return console.log("wind_win",g,b),"east"!=g&&$.each(b,function(a,b){console.log(a,b),console.log("player",b.name,"score:",b.score,"wind: ",b.wind),b.wind=d(b.wind,!0),console.log("new wind: ",b.wind)}),console.log("players",b),a.set("players",b),b}}}]),Mahjong.service("game",["storage",function(a){var b=a.get("games")||[];return{get:function(){return b},create:function(){return b=[{prevailing_wind:"east",rounds:[{score:Array(4)}]}],a.set("games",b),b},updatePlayerScore:function(c,d,e){var f=_.last(b),g=_.last(f.rounds);return g.score[e]=d,c.options.mahjong&&(g.mahjong_idx=e),a.set("games",b),b},updateRounds:function(c){{var d=_.last(b);_.last(d.rounds)}return 2==d.rounds.length?b.push({prevailing_wind:c(d.prevailing_wind),rounds:[{score:Array(4)}]}):d.rounds.push({score:Array(4)}),a.set("games",b),b},isNewRound:function(){var a=_.last(b),c=_.last(a.rounds);console.log("last round: ",c);var d=_.filter(c.score,function(a){return void 0!==a&&null!==a});return 4==d.length}}}]),Mahjong.controller("gameCtrl",["$scope","$http","players","game","storage",function(a,b,c,d){var e=function(){a.$watch("lang",function(){b.get("/translations/translation_"+a.lang+".json").success(function(b){a.text=b})}),a.lang="ru",a.show_result=!0,a.$on("handCalculated",h),a.players=c.get(),a.games=d.get(),console.log(a.players,a.games),$.isEmptyObject(a.games)||(a.game_started=!0)};a.getWindName=function(b,c){var d={east:["EAST","EASTERN"],south:["SOUTH","SOUTHERN"],west:["WEST","WESTERN"],north:["NORTH","NORTHERN"]}[b];return a.text?c?a.text[d[1]]:a.text[d[0]]:void 0};var f=function(b){var c=_.findWhere(a.players,{wind:b});return _.indexOf(a.players,c)},g=function(a,b){var c=["east","south","west","north"],d=_.indexOf(c,a),e=c[d+1]||c[0];return b&&(e=c[d-1]||_.last(c)),e};a.changeLang=function(b){a.lang=b},a.startNewGame=function(){a.players=c.newGame(),a.games=d.create(),a.game_started=!0},a.openHandScore=function(b){a.$broadcast("handOpened",b)};var h=function(b,e,h){var i=_.last(a.games);a.games=d.updatePlayerScore(e,h,f(e.wind)),d.isNewRound()&&(alert(a.text.ROUND_IS_DONE),a.players=c.updateScore(i,g),a.games=d.updateRounds(g)),a.$digest()};e()}]),Mahjong.controller("handCtrl",["$scope","handCalculations",function(a,b){var c=function(){f(),$("#countPoints").on("hidden.bs.modal",e),a.$on("handOpened",function(b,c){a.hand.wind=c})};a.addBone=function(b,c){var d=_.filter(a.hand.bones,function(a){return a.type==b&&a.value==c});if(!(("flower"==b||"season"==b)&&d.length||d.length>3)){var e=_.filter(a.hand.bones,function(a){return"flower"==a.type||"season"==a.type});a.hand.bones.length>=18+e.length||a.hand.bones.push({type:b,value:c,opened:!1})}},a.removeBone=function(b,c){a.hand.bones.splice(c,1)},a.boneClicked=function(b,c){if("picking hand"==a.hand.mode&&a.removeBone(b,c),"picking options"==a.hand.mode){var e=a.hand.bones;b.opened=!b.opened,d(b,e[c+1])&&d(b,e[c+2])&&(e[c+1].opened=b.opened,e[c+2].opened=b.opened,d(b,e[c+3])&&(e[c+3].opened=b.opened))}},a.calculate=function(){a.hand.mode="calculation",a.score=b.calculate(a.hand,a.$parent.$parent.text)};var d=function(a,b){return a&&b&&a.value==b.value&&a.type==b.type},e=function(){a.score&&(a.$emit("handCalculated",a.hand,a.score.score),f(),a.$digest())},f=function(){var b=a.$parent.games;a.hand={mode:"picking hand",bones:[],prevailing_wind:b&&b.length&&_.last(b).prevailing_wind||"east",options:{}}};c()}]),Mahjong.factory("handCalculations",[function(){var a,b,c,d=function(){var a=_.compact(arguments),b=!0;return $.each(a,function(c,d){(d.type!=a[0].type||d.value!=a[0].value||d.opened!=a[0].opened)&&(b=!1)}),a.length==arguments.length&&b},e=function(a,b){return _.filter(b,function(b){return d(a,b)})},f=function(){for(var a=_.sortBy(_.compact(arguments),"value"),b=!0,c=1;c<a.length;c++)(a[c].type!=a[c-1].type||a[c].value!=a[c-1].value+1||a[c].opened!=a[c-1].opened)&&(b=!1);return a.length==arguments.length&&b},g=function(a,b){return h(b)==a},h=function(a){var b="suit";return("dragon"==a.type||"wind"==a.type)&&(b="noble"),(1==a.value||9==a.value)&&(b="terminal"),b},i=function(a,c){b.combinations.push({type:a,bone:c})},j=function(a,c){b.calculations.push({name:c,points:a})},k=function(a,c){b.doublings.push({name:a,count:2*c||2})},l=function(){b.bonuses=_.filter(a.bones,function(a){return"season"==a.type||"flower"==a.type}),a.bones=_.difference(a.bones,b.bonuses)},m=function(){for(var b=0;b<a.bones.length;b++){var c=a.bones[b],e="",g=a.bones[b+1],h=a.bones[b+2],j=a.bones[b+3];d(c,g,h)&&(e="pang"),d(c,g,h,j)&&(e="kong"),f(c,g,h)&&(e="chou"),e&&(i(e,c),a.bones.splice(b,"kong"==e?4:3),b--)}},n=function(){var b,c,d;for(b=0;b<a.bones.length;b++)c=a.bones[b],d=e(c,a.bones),d.length>2&&(i(3==d.length?"pang":"kong",c),a.bones=_.difference(a.bones,d),b--);var g=_.groupBy(a.bones,"type");for($.each(g,function(d,e){if(-1!=_.indexOf(["bamboo","pin","man"],e))for(d=_.sortBy(d,"value"),b=0;b<d.length;b++){c=d[b];var g=d[b+1],h=d[b+2];f(c,g,h)&&(i("chou",c),d.splice(b,3),a.bones=_.difference(a.bones,[c,g,h]),b--)}}),b=0;b<a.bones.length;b++)c=a.bones[b],d=e(c,a.bones),2==d.length&&(i("pair",c),a.bones=_.difference(a.bones,d),b--);a.bones.length>0&&($.each(a.bones,function(a,b){i("one",b)}),a.bones=[])},o=function(){if(a.options.mahjong){var d=b.combinations,e=_.countBy(d,"type"),f={THIRTEEN_ORPHANS:function(){return 2==_.size(e)&&12==e.one&&1==e.pair?_.filter(d,function(a){return g("terminal",a.bone)||g("noble",a.bone)}).length==d.length:void 0},TREASURE:function(){var a=d[0].bone;return _.filter(d,function(b){return"chou"!=b.type&&"one"!=b.type&&1==e.pair&&0==b.bone.opened&&b.bone.type==a.type}).length==d.length},HONOURS:function(){return _.filter(d,function(a){return g("noble",a.bone)&&1==e.pair&&!e.one}).length==d.length},HEADS_AND_TAILS:function(){return _.filter(d,function(a){return"chou"!=a.type&&"one"!=a.type&&g("terminal",a.bone)&&1==e.pair}).length==d.length},IMPERIAL_JADE:function(){return _.filter(d,function(a){return"dragon"==a.bone.type&&"green"==a.bone.value||"bamboo"==a.bone.type&&-1!=_.indexOf([2,3,4,6,8],a.bone.value)}).length==d.length},HEAVENLY_TWINS:function(){var a=_.filter(d,function(a){return("pair"==a.type||"kong"==a.type&&!a.bone.opened)&&g("noble",a.bone)}),b=d[0].bone,c=_.filter(d,function(a){return!g("noble",a.bone)&&("pair"==a.type||"kong"==a.type&&!a.bone.opened)&&a.bone.type==b.type});return a.length==d.length||c.length==d.length},GRAND_MASTERS:function(){var a=_.filter(d,function(a){return("pang"==a.type||"kong"==a.type)&&"dragon"==a.bone.type}),b=_.difference(d,a),c=_.filter(b,function(a){return a.bone.type==b[0].bone.type&&"chou"!=a.type&&"one"!=a.type});return 3==a.length&&2==b.length&&c.length==b.length},FOUR_BLESSINGS:function(){return 4==_.filter(d,function(a){return("pang"==a.type||"kong"==a.type)&&"wind"==a.bone.type}).length&&1==e.pair},FOURFOLD_PLENTY:function(){return 4==e.kong&&1==e.pair},MOON_IN_THE_SEA:function(){return a.options.before_dead_wall_1_pin},GATHERING_BLOSSOM:function(){return a.options.free_bone_5_pin}};return $.each(f,function(a,d){return d()?(b.limited=c.hand.limited[a],j(500,c.hand.LIMITED_COMBINATION+b.limited),!1):void 0}),b.limited}},p=function(){b.combinations.length&&($.each(b.combinations,function(b,d){var e=0;if(("pang"==d.type||"kong"==d.type)&&(e={kong:{terminal:32,suit:16,noble:32},pang:{terminal:8,suit:4,noble:8}}[d.type][h(d.bone)],d.bone.opened&&(e/=2)),"pair"==d.type&&("dragon"==d.bone.type&&(e=2),"wind"==d.bone.type&&d.bone.value==a.wind&&(e=2),"wind"==d.bone.type&&d.bone.value==a.round_wind&&(e+=2)),e){var f=c.hand.scoring,g=f[d.bone.type.toUpperCase()],i={pang:(d.bone.opened?f.OPENED:f.CLOSED)+f.PANG+g+" "+d.bone.value,kong:(d.bone.opened?f.OPENED:f.CLOSED)+f.KONG+g+" "+d.bone.value,pair:f.PAIR+" "+g};j(e,i[d.type])}}),a.options.last_bone_from_wall&&j(2,c.hand.LAST_BONE_FROM_WALL),a.options.the_only_possible&&j(2,c.hand.THE_ONLY_POSIBLE))},q=function(){var d=b.combinations,e={DRAGONS:function(){return _.filter(d,function(a){return("pang"==a.type||"kong"==a.type)&&"dragon"==a.bone.type}).length},PREVAILING_WINDS:function(){return _.filter(d,function(b){return("pang"==b.type||"kong"==b.type)&&"wind"==b.bone.type&&b.bone.value==a.prevailing_wind}).length},OWN_WINDS:function(){return _.filter(d,function(b){return("pang"==b.type||"kong"==b.type)&&"wind"==b.bone.type&&b.bone.value==a.wind}).length},HALF_SUITE:function(){var a=_.keys(_.groupBy(d,function(a){return a.bone.type}));return _.intersection(a,["dragon","wind"]).length>0&&1==_.without(a,"dragon","wind").length},FULL_SUITE:function(){var a=_.keys(_.groupBy(d,function(a){return a.bone.type}));return 4*Number(1==a.length&&("pin"==a[0]||"man"==a[0]||"bamboo"==a[0]))},ONLY_19_DRAGONS_WINDS:function(){var a=_.keys(_.groupBy(d,function(a){return a.bone.type}));return _.filter(d,function(a){return"chou"!=a.type&&(g("noble",a.bone)||g("terminal",a.bone))}).length==d.length&&_.without(a,"dragon","wind").length>0},ONLY_DRAGONS_WINDS:function(){return 4*Number(_.filter(d,function(a){return g("noble",a.bone)}).length==d.length)},ONE_SUIT:function(){var a=_.countBy(b.bonuses,"type"),c=a.flower&&4==a.flower||a.season&&4==a.season;return c?4:0},OWN_PREVAILING_BONUS:function(){var c=_.countBy(b.bonuses,"type"),d=c.flower&&4==c.flower||c.season&&4==c.season,e=_.find(b.bonuses,function(b){var c={east:1,south:2,west:3,north:4};return c[a.wind]==b.value||c[a.prevailing_wind]==b.value});return e&&!d}};if($.each(e,function(a,b){var d=Number(b());d&&k(c.hand.doublings[a],d)}),a.options.mahjong){var f={ONLY_PANGS:function(){var a=_.groupBy(d,"type");return a.pang&&4==a.pang.length&&a.pair&&1==a.pair.length},CONCEALED_HAND:function(){return _.filter(d,function(a){return!a.bone.opened}).length==d.length},NO_POINTS:function(){return 0==b.calculations.length},LOOSE_TILE:function(){return a.options.free_bone},LAST_TILE:function(){return a.options.before_dead_wall},ROBBING_KONG:function(){return a.options.kong_robbery},LITTLE_THREE_WINDS:function(){var a=_.groupBy(d,function(a){return a.bone.type}).wind;return a&&4==a.length?(a=_.groupBy(a,"type"),2*(a.pair&&1==a.pair.length)):!1},LITTLE_THREE_DRAGONS:function(){var a=_.groupBy(d,function(a){return a.bone.type}).dragon;return a&&3==a.length?(a=_.groupBy(a,"type"),a.pair&&1==a.pair.length):!1},READY_HAND:function(){return a.options.ready_hand_from_start},TWO_THRE_KONGS:function(){var a=_.groupBy(d,"type").kong;return a&&a.length>2&&a.length<4}};$.each(f,function(a,b){var d=Number(b());d&&k(c.hand.mahjong_doublings[a],d)}),j(20,c.hand.scoring.MAHJONG)}},r=function(){b.full_score=_.reduce(b.calculations,function(a,b){return a+b.points},0),$.each(b.doublings,function(a,c){b.full_score=c.count*b.full_score}),b.score=b.full_score>500?500:b.full_score,b.score=10*Math.ceil(b.score/10)},s=function(d){return a=_.clone(d),b={combinations:[],calculations:[],doublings:[]},l(),m(),n(),o()||(p(),q(),b.bonuses.length>0&&j(4*b.bonuses.length,c.hand.scoring.BONUSES)),r(),b};return{calculate:function(a,b){return c=b,s(a)}}}]),Mahjong.directive("triggerModal",function(){return{link:function(a,b,c){b.on("click",function(){$("body").append('<div class="modal-backdrop fade in"></div>');var a=$(c.triggerModal);a.css({display:"block"}).addClass("in").triggerHandler("shown.bs.modal"),a.find("[data-dismiss]").on("click",function(){$(".modal-backdrop").remove(),a.css({display:"none"}).removeClass("in").triggerHandler("hidden.bs.modal"),a.find("[data-dismiss]").off("click")})})}}});